---
title: "Untitled"
output: html_document
date: '2023-03-15'
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: 72
---

#Package

```{r}

library(DHARMa)
library(broom.mixed)
library(tidyverse)
library(glmmTMB)
library(elrm)
library(logistf)

library(ggstatsplot)

```

#General

i)  Perhaps the difference in BM shoudl be expressed as % of lighter
    individual BM instread as in absolute BM

ii) I guess some bits could be moved to data prep but the aim here is to
    tweak the data to visualize what is going on. Perhaps once it is
    consolidated and also used for models I can move to dataprep


#wd 

```{r}

DC_dir <- "C:/Users/Philippe/Dropbox/PhD_20150515/Research projects/DMR_HelperBreedingOpp/DC/DC_Analyses"


setwd(DC_dir)

```

#CSV

One issue is that DC_and DC_Info_F do not contain SamplingCat. Would be good to have it directly there rather than in DC_Info_Group

```{r}

#DC info group 
DC_Info_Group <- read.csv("DC_Info_Group_20240710.csv") 
names(DC_Info_Group)



#DC info
#If brought as csv I need to do all the relabelling and reformatting
#Usually I won't work with the csv, but in case I have it if R crashes
DC_Info_F <- read.csv("DC_Info_F_20240710.csv") %>% 
  
  #REFORMAT DATE
  mutate(BirthDate = ymd(BirthDate),
         IsolationDate = ymd(IsolationDate),
         PairingDate = ymd(PairingDate)) %>% 
  
  #ADD SAMPLING CAT
  left_join(., DC_Info_Group %>% 
              distinct(ExperimentalGroup,
                       Sampling_Cat)) %>% 
  relocate(Sampling_Cat) %>% 
  arrange(Sampling_Cat,
          ExperimentalGroup,
          EvictionStatus)

View(DC_Info_F)


#Relevant weight
DC_ClosestWeight <- read.csv("DC_ClosestWeight_20240710.csv")
names()


#Urine info 
#check what info is there
DC_Info_Urine_F <- read.csv("DC_Info_Urine_F_20240710.csv") %>% 
    rename(SampleID = UrineNumber)
View(DC_Info_Urine_F)


#Hormone concentration 
#write csv
DC_Conc_All <-read.csv("DC_Conc_All_20240710.csv")


```


#Data

Create a dataset for the plotting of hormone data. This file can be built as we go and also information could be added (Elo, weight etc. The file could be used for statistical analyses

```{r Hormone}

Hormones_All <- DC_Info_Urine_F %>% 
  left_join(., DC_Conc_All)


```


```{r Weight}

#Join DC_Info with closest weight
#So far done for female only 
DC_Info_ClosestWeight <- DC_Info_F %>% 
  left_join(., DC_ClosestWeight) %>% 
  filter(WeightDiff_Type == "Before")
View(DC_Info_ClosestWeight)



#Assign a reference for heavier animal at isolation 
HeavierIsolation <- DC_Info_ClosestWeight%>%
  filter(DateType == "Isolation") %>%
  #ADD HEAVIER REF 
  group_by(ExperimentalGroup) %>% 
  arrange(desc(Weight)) %>% 
  mutate(Isolation_HeavierRef = row_number()) %>% 
  ungroup() %>% 
  #ARRANGE
  arrange(ExperimentalGroup, 
          Isolation_HeavierRef) %>% 
  distinct(AnimalID,
           Isolation_HeavierRef)
View(HeavierIsolation)


#Select relevant Date type of weight
ClosestWeight_Milestone <- DC_Info_ClosestWeight %>% 
  
  #RETAIN RELEVANT WEIGHT DATES
  filter(DateType %in% c("Isolation", "Pairing", "Eviction"), 
         WeightDiff_Type == "Before") %>% 
  
  #ADD HEAVIER REF 
  left_join(.,HeavierIsolation) %>% 
  
  #ADD EVICTION STATUS FOR PLOTTING INGROUP ASSIGN EVICTOR AND EVICTEE
  mutate(EvictionStatus_Plot = case_when(EvictionStatus == "InGroup" & Isolation_HeavierRef == 1 ~ "Evictor", 
                                        EvictionStatus == "InGroup" & Isolation_HeavierRef == 2 ~ "Evictee", 
                                        TRUE ~ as.character(EvictionStatus))) %>% 
  
  mutate(EvictionStatus_Plot = fct_relevel(EvictionStatus_Plot, "Evictor", "Evictee")) %>% 
  
  #RELEVEL DATE TYPE
  mutate(DateType = fct_relevel(DateType, "Isolation", "Pairing", "Eviction")) %>% 
  
  #ARRANGE
  #Heavier animal first 
  arrange(ExperimentalUnit,
          DateType,
          desc(Weight))
View(ClosestWeight_Milestone)



###################################################DC 

#Count of weigth per experimental group and Date Type
#Should be = 2
C_WeightDiff_Count <- ClosestWeight_Milestone %>% 
       group_by(ExperimentalGroup, 
                DateType) %>% 
       mutate(n = n())
names(C_WeightDiff_Count)

#Not equal to 2
C_WeightDiff_WrongCount <- C_WeightDiff_Count %>% 
       filter(n !=2)
View(C_WeightDiff_WrongCount)
#All good 2 weights per category

# View(ClosestWeight_Milestone %>% 
#   filter(AnimalID %in% c ("PF009", "DRF015")))

#Same weight
SameWeight <- ClosestWeight_Milestone %>% 
  group_by(ExperimentalGroup,
           DateType) %>% 
  mutate(WeightDiff = Weight - lead(Weight)) %>% 
  filter(WeightDiff == 0)
View(SameWeight)
#No weight difference of 0
#Heavier animals always first 


#Min
#Max
#Avg 
#Median 
#Off day difference for each categor

#Percentage of data that was not collected on the day of isolation, pairing or eviction 

```

Weight diff contains all information from DC_Info_F, with weight
difference. It could be moved to data prep

Differences in bm are at milestones and not at every date

```{r WeightDiff}

WeightDiff <- ClosestWeight_Milestone %>% 
  
  #ADD PARTNER WEIGHT INFO
  left_join(ClosestWeight_Milestone %>% 
              select(AnimalID, 
                     DateType,
                     Weight) %>% 
              rename(PartnerWeight = Weight), by=c("PartnerID" = "AnimalID", "DateType" = "DateType")) %>% 
  
  #ADD WEIGHT DIFF 
  mutate(WeightDiff = Weight - PartnerWeight) %>% 
  
  #ADD HEAVIER CATEGORY 
  group_by(ExperimentalGroup,
           DateType) %>% 
  mutate(WeightDiff_Cat = case_when(WeightDiff > 0 ~ "Heavier",
                                    WeightDiff == 0 ~ "Same",
                                    WeightDiff < 0 ~ "Lighter"))
View(WeightDiff)

names(WeightDiff)

unique(WeightDiff$BS_PlotCategory)

```


```{r Focal}

#Heavier animal as focal 
Heavier <- WeightDiff %>% 
  filter(WeightDiff > 0)
View(Heavier)

#Lighter animal as focal
Lighter <- WeightDiff %>% 
  filter(WeightDiff < 0)

#Remove info of lighter individual at isolation
HeavierIsol <- WeightDiff  %>% 
  filter(Isolation_HeavierRef == 1)
View(HeavierIsol)

#Could add heavier pairing 
#Could add heavier eviction

#Evictor as focal
#InGroup have been assigned a status 
Evictor <- WeightDiff  %>% 
  filter(EvictionStatus_Plot == "Evictor")

#Evictee as focal
#InGroup have been assigned a status 
Evictee <- WeightDiff  %>% 
  filter(EvictionStatus_Plot == "Evictee")

#Older as focal 
Older <- WeightDiff  %>% 
  filter(AgeDiff > 0)

#Younger as focal 
Younger <- WeightDiff  %>% 
  filter(AgeDiff < 0)

```


```{r Hormone}

#Join DC_Info to hormone []
DE_Hormone <- DC_Info_Urine_F %>% 
  inner_join(., DC_Conc_All) %>% 
  filter(!SampleID %in% c(0,1))

#Are there samples in [] that are not in DC_Info_Urine_F
SampleID_NoInfo <- anti_join(DE_Hormone, DC_Info_Urine_F) %>% 
  distinct(SampleID)
View(SampleID_NoInfo)
#Only sample 0 and 1 are missing 

```


Using data exploration in the code below, one can create sampling
category. It is useful to add here at the beginning of the code for
subsequent filtering.

*Cat 1: Rapid Conception*

*Cat 2: Rapid Pre-Conception*

*Cat 3: Slow Conception*

*Cat 4: Slow Pre-Conception*

*Cat 5: No eviction*


#Sample size

13x sub treatment 12x queen treatment; 2 queens are lighter and could be
excluded from analyses

```{r Treatment}

SampleSize <- DC_Info_F %>% 
  group_by(Treatment) %>% 
  summarize(SampleSize = n_distinct(ExperimentalGroup)) %>% 
  ungroup()
View(SampleSize)

```


#Experimental design


##BM absolute summary

At isolation body-mass and variance in body-mass is greater in the sub
treatment.

For the next round, it would be useful to use heavier BF (\>150-160).
See BM differences section for further info on BM differences.

In the queen treatment, Queen are relatively heavier than NBF, but we
have decided to constrain this by design.

```{r Summary}

names(ClosestWeight_Milestone )

#Without distinction Sub-Queen 
BM_Summary <- ClosestWeight_Milestone %>% 
  group_by(Treatment) %>% 
  summarize(Min = min(Weight),
         Max = max(Weight),
         Median = median(Weight),
         Avg = mean(Weight),
         FirstQuartile = quantile(Weight, probs = 0.25),
         ThirdQuartile = quantile(Weight, probs = 0.75),
         SD = sd(Weight)) %>% 
  ungroup()
View(BM_Summary)


#With Distinction Sub-Queen
BM_Summary_SubQueen <- ClosestWeight_Milestone %>% 
  group_by(Treatment, 
           BS_Original) %>% 
  summarize(Min = min(Weight),
         Max = max(Weight),
         Median = median(Weight),
         Avg = mean(Weight),
         FirstQuartile = quantile(Weight, probs = 0.25),
         ThirdQuartile = quantile(Weight, probs = 0.75)) %>% 
  ungroup()
View(BM_Summary_SubQueen)


#How many individuals were heavier 
         

```


##BM absolute LM

Linear models show no difference in body mass at both isolation and
pairing between treatments

Within the queen treatment, queen tend to be heavier at isolation and
are significantly heavier at pairing than sub.

There is no significant differences in BM between helpers from the sub and queen treatment at isolation or pairing



```{r LM}

#At isolation 
#Already moved into analyses (No model validation done yet)
LM_BMIsol <- lm(Weight ~ Treatment, 
              data = ClosestWeight_Milestone %>% 
                filter(DateType == "Isolation"))
summary(LM_BMIsol)


#At pairing
#Already moved into analyses (No model validation done yet)
LM_BMPairing <- lm(Weight ~ Treatment, 
              data = ClosestWeight_Milestone %>% 
                filter(DateType == "Pairing")) 
summary(LM_BMPairing)


#Are queen heavier than sub from both treatment at isolation
LM_BMIsol_QueenSub <- lm(Weight ~ BS_Original, 
              data = ClosestWeight_Milestone %>% 
                filter(DateType == "Isolation")) 
summary(LM_BMIsol_QueenSub)


#Are queen heavier than sub from both treatment at pairing
 LM_BMPairing_QueenSub <- lm(Weight ~ BS_Original, 
              data = ClosestWeight_Milestone %>% 
                filter(DateType == "Pairing")) 
summary(LM_BMPairing_QueenSub)


##Are queen heavier than sub from queen treatment at isolation
LM_BMIsol_QueenSub_QT <- lm(Weight ~ BS_Original, 
              data = ClosestWeight_Milestone %>% 
                filter(DateType == "Isolation",
                       Treatment == "Queen"))
summary(LM_BMIsol_QueenSub_QT)
#There is a trend for queen to be heavier at isolation
#Sub are on average 13 grams lighter than queens in the queen treatment
#Despite this they are at a competitive disadvantage


#Are queen heavier than sub from queen treatment at pairing
LM_BMPairing_QueenSub_QT <- lm(Weight ~ BS_Original, 
              data = ClosestWeight_Milestone %>% 
                filter(DateType == "Pairing",
                       Treatment == "Queen"))
summary(LM_BMPairing_QueenSub_QT)
#Queen are significantlly heavier at pairing than Sub


#Does helpers' bm depend on treatment 
#Already moved into analyses (No model validation done yet)
LM_BMIsol_H <- lm(Weight ~ Treatment, 
              data = ClosestWeight_Milestone %>% 
                filter(DateType == "Isolation",
                       BS_Original != "Breeder"))
summary(LM_BMIsol_H)
#No diff


#At pairing
#Already moved into analyses (No model validation done yet)
LM_BMPairing_H <- lm(Weight ~ Treatment, 
              data = ClosestWeight_Milestone %>% 
                filter(DateType == "Pairing",
                       BS_Original != "Breeder"))
summary(LM_BMPairing_H)
#No diff 


#Are queen heavier than all other females? 
LM_BMPairing_QueenSub <- lm(Weight ~ BS_PlotCategory, 
              data = ClosestWeight_Milestone %>% 
                filter(DateType == "Pairing"))
summary(LM_BMPairing_QueenSub)


```

##BM absolute plot 

```{r Plot}

#By treatment at isolation
ggplot(ClosestWeight_Milestone %>% 
         filter(DateType == "Isolation"),
       aes(x=Treatment,y=Weight)) + 
  
  #ADD BOXPLOT
  geom_boxplot(outlier.shape = NA) +
  
  #ADD POINTS 
  geom_jitter(width = 0.3, height = 0, size = 2.5, aes(col = BS_Original)) +

  theme_classic()


#Plot separating sub_Q and Queen 
ggplot(ClosestWeight_Milestone  %>% 
         filter(DateType == "Isolation"),
       aes(x=BS_PlotCategory,y=Weight)) + 
  
  #ADD BOXPLOT
  geom_boxplot(outlier.shape = NA) +
  
  #ADD POINTS 
  geom_jitter(width = 0.3, height = 0, size = 2.5) +

  theme_classic()

```


##BM Differences 


In Chouffe, Leffe and Bitburger the helper was heavier than the queen at isolation. 

In the queen treatment, queens were heavier than subordinate in all but
two experimental pair: 

i) Chouffe: NBF was 3 grams heavier 
ii) BitBurger: NBF was 8 grams heavier
iii) Leffe: NBF was 4g heavier at isolation, same at pairing, lighter at eviction.

A possibility for analyses could be to remove these 3 groups as see how it affects results. 

The suggestion I had made before last round can be found in version earlier of July 2024.

```{r Summary}

#Differences in BM at isolation

BMdiff_Summary <- HeavierIsol %>% 
  filter(DateType == "Isolation") %>% 
  group_by(Treatment) %>% 
  summarize(Min = min(WeightDiff),
         Max = max(WeightDiff),
         Median = median(WeightDiff),
         Avg = mean(WeightDiff),
         FirstQuartile = quantile(WeightDiff, probs = 0.25),
         ThirdQuartile = quantile(WeightDiff, probs = 0.75),
         SD = sd(WeightDiff)) %>% 
  ungroup()
View(BMdiff_Summary)

```

```{r Details}

#Sub heavier than queen at isolation 
View(HeavierIsol %>% 
       filter(Treatment == "Queen",
              Isolation_HeavierRef == 1, 
              BS_Original == "Helper"))
```


##BM differences models

There is no difference in BM across treatments at isolation and pairing


```{r Models}

#At isolation 
LM_BMDiff_Isol <- lm(WeightDiff ~ Treatment, 
              data = WeightDiff %>% 
                filter(DateType == "Isolation",
                       WeightDiff_Cat == "Heavier"))
summary(LM_BMDiff_Isol)
#No significant difference

#At pairing
LM_BMDiff_Pairing <- lm(WeightDiff ~ Treatment, 
              data = WeightDiff %>% 
                filter(DateType == "Pairing",
                       WeightDiff_Cat == "Heavier"))
summary(LM_BMDiff_Pairing)
#No significant difference

```


##BM differences plot 

Though it looks the difference in BM at isolation is larger than the helper treatment, this difference is not significant 

```{r Plot}

#Heavier as focal 
ggplot(Heavier, aes(x = Treatment, y = WeightDiff)) + 
   
  facet_wrap(~ DateType, ncol = 1) +     # Facet the plot by DateType, single column
  geom_boxplot(outlier.shape = NA) +     # Add boxplot without outlier points
  
  geom_jitter(width = 0.3, height = 0, size = 2.5, aes(col = EvictionStatus)) + # Add jittered points colored by EvictionStatus
  
  theme_classic()      


```


## Age

Females from queen treatments are on average 3.9 years old and 2.9 years old in the sisters treatment. Queens are on average 5.61 years and helpers 2.67 years old. On average helpers from the queen treatment were 300 days older than helpers in the sub treatment 2.91 years old VS 2.13 years old  

The suggestion I had made before last round are available in version before July 2024.


```{r Summary}
names(DC_Info)

#Age summary 
Age_Summary <- DC_Info_F %>% 
  
  #SUMMARY
  group_by(Treatment) %>% 
  summarize(Min = min(Age),
         Max = max(Age),
         Median = median(Age),
         Avg = mean(Age),
         FirstQuartile = quantile(Age, probs = 0.25),
         ThirdQuartile = quantile(Age, probs = 0.75),
         SD = sd(Age)) %>% 
  ungroup()
View(Age_Summary)


#Age summary, separating queen and sub in queen treatment
Age_SubQueen_Summary <- DC_Info_F %>% 
  #AGE AT ISOL
  mutate(Age = IsolationDate - BirthDate) %>% 
  
  #SUMMARY
  group_by(Treatment,
           BS_Original) %>% 
  summarize(Min = min(Age),
         Max = max(Age),
         Median = median(Age),
         Avg = mean(Age),
         FirstQuartile = quantile(Age, probs = 0.25),
         ThirdQuartile = quantile(Age, probs = 0.75),
         SD = sd(Age)) %>% 
  ungroup()
View(Age_SubQueen_Summary)



#Age summary, separating queen and sub in queen treatment
Age_BSoriginal_Summary <- DC_Info_F %>% 
  #AGE AT ISOL
  mutate(Age = IsolationDate - BirthDate) %>% 
  
  #SUMMARY
  group_by(BS_Original) %>% 
  summarize(Min = min(Age),
         Max = max(Age),
         Median = median(Age),
         Avg = mean(Age),
         FirstQuartile = quantile(Age, probs = 0.25),
         ThirdQuartile = quantile(Age, probs = 0.75),
         SD = sd(Age)) %>% 
  ungroup()

View(Age_BSoriginal_Summary)

```


##Age models 

There is a trend for individuals to be older in the queen treatment compared to the helper treatment. This is driven by queens being much older 

Q are 2.9 years older than helpers and this difference is significant


```{r Models}


LM_Age <- lm(as.integer(Age) ~ Treatment, 
              data = DC_Info_F)
summary(LM_Age)
#There is a trend for females to be older in the queen treatment. It certainly is driven by the queens 


#Difference in age between Q and helper
LM_Age_ByStatus <- lm(as.integer(Age) ~ BS_Original, 
              data = DC_Info_F)
summary(LM_Age_ByStatus)
#BF are significantly older than helper 


#Difference in Age between sub of each treatment as graph suggest there may be a difference
LM_Age_Helper <- lm(as.integer(Age) ~ Treatment, 
              data = DC_Info_F %>% 
                filter(BS_Original != "Breeder"))
summary(LM_Age_Helper)
#No significant diff


#Difference in Age between sub of each treatment as graph suggest there may be a difference
LM_Age_Helper <- lm(as.integer(Age) ~ Treatment, 
              data = DC_Info_F %>% 
                filter(BS_Original != "Breeder"))
summary(LM_Age_Helper)
#No significant diff

names(DC_Info_F)
unique(DC_Info_F$BS_Original)


```


##Age plot 

```{r Plot}

#By treatment
ggplot(DC_Info_F,
       aes(x=Treatment,y=Age)) + 
  
  #ADD BOXPLOT
  geom_boxplot(outlier.shape = NA) +
  
  #ADD POINTS 
  geom_jitter(width = 0.3, height = 0, size = 2.5, aes(col = BS_Original)) +

  theme_classic()


#By treatment, separating queen and 
ggplot(DC_Info_F,
       aes(x=Treatment,y=Age)) + 
  
  #ADD BOXPLOT
  geom_boxplot(outlier.shape = NA) +
  
  #ADD POINTS 
  geom_jitter(width = 0.3, height = 0, size = 2.5, aes(col = BS_Original)) +

  theme_classic()



#By treatment + separating sub_Q and Queen 
ggplot(DC_Info_F,
       aes(x=BS_PlotCategory,y=Age/365)) + 
  
  #ADD BOXPLOT
  geom_boxplot(outlier.shape = NA) +
  
  #ADD POINTS 
  geom_jitter(width = 0.3, height = 0, size = 2.5) +

  theme_classic()
#LM suggest no significant diff in the age of sub across treatment







```

## Age difference

In the queen treatments differences in age is 3.34 years. In the helper treatment it is 0.54 years 

Suggestion I had made for last round are available in version earlier than July 2024

```{r Summary}

AgeDiff_Summary <- Older %>% 

  #SUMMARY
  group_by(Treatment) %>% 
  summarize(Min = min(AgeDiff),
         Max = max(AgeDiff),
         Median = median(AgeDiff),
         Avg = mean(AgeDiff),
         FirstQuartile = quantile(AgeDiff, probs = 0.25),
         ThirdQuartile = quantile(AgeDiff, probs = 0.75),
         SD = sd(AgeDiff)) %>% 
  ungroup()
View(AgeDiff_Summary)


```


##Age differences model 

The age differences between females of the queen treatment is significantly larger than in the helpers treatment

```{r Model}

View(DC_Info_F)

LM_AgeDiff <- lm(as.integer(AgeDiff) ~ Treatment, 
              data = DC_Info_F %>% 
                filter(AgeDiff_Cat == "Older"))
summary(LM_AgeDiff)
#There is a super significant difference in Age 

```


##Age differences plot 

There is a complete separation of Age differences across treatment except from one point in the sub treatment where there was no eviction

```{r Plot}

ggplot(Older %>% 
         filter(DateType == "Isolation"),
       aes(x=Treatment,y=AgeDiff)) + 
  
  #ADD BOXPLOT
  geom_boxplot(outlier.shape = NA) +
  
  #ADD POINTS 
  geom_jitter(width = 0.3, height = 0, size = 2.5, aes(col=EvictionStatus)) +

  theme_classic()

```


##Correl Age and BM 

There is no significant relationship between body mass and age at isolation whether BS_Original, interactions terms between Age and BS_Original, independent or interacted quadratic effects are considered or not

Perhaps I should rerun the code by excluding the two groups where we had no evictions as the existence of correlation is especially important for models on evictions

```{r Data}

AgeBM_Data <- ClosestWeight_Milestone %>% 
  select(ExperimentalGroup,
         AnimalID,
         Treatment,
         BS_Original,
         DateType,
         Weight,
         Age)
View(AgeBM_Data)

```

Perhaps this graph could be made prettier and add as supplementary materials 

```{r Plot}

ggplot(AgeBM_Data %>% 
         filter(DateType == "Isolation"), aes(x = Age/365.25, y = Weight, color = BS_Original)) +
  geom_point() +
  geom_smooth(method = "lm", aes(group = BS_Original), se = TRUE) +
  labs(title = "Relationship between Age and Weight",
       x = "Age",
       y = "Weight",
       color = "BS_Original") +
  theme_minimal()

```


```{r Model }

#No BS_Original
BMAge_NoBS <- glmmTMB (Weight ~ as.integer(Age/364.25), data = AgeBM_Data %>% 
         filter(DateType == "Isolation"))
summary(BMAge_NoBS)
#No relationship 


#Add BS_Original
BMAge_L <- glmmTMB(Weight ~ as.integer(Age/364.25) * BS_Original, data = AgeBM_Data %>% 
         filter(DateType == "Isolation"))
summary(BMAge_L)
AIC(BMAge_M)

#Add independent Quadratic effect 
BMAge_Q <- glmmTMB(Weight ~ as.integer(Age/364.25) * BS_Original + I((as.integer(Age/364.25))^2),
                   data = AgeBM_Data %>% filter(DateType == "Isolation"))
summary(BMAge_Q)
#Positive quadratic effect is Ushape
AIC(BMAge_Q)#Model not better than the previosu Linear 


#Add interactions BS_Original and Quadratic effect
BMAge_QI <- glmmTMB(Weight ~ as.integer(Age/364.25) * BS_Original + I((as.integer(Age/364.25))^2) * BS_Original,
                   data = AgeBM_Data %>% filter(DateType == "Isolation"))
summary(BMAge_QI)
AIC(BMAge_QI)
#Worse


```

```{r Model validation}

AgeBM_R <- simulateResiduals(BMAge_M)

plot(AgeBM_R)

```


##Correlation BM and Age Diff

Overall older animals that are older are also heavier. This is particularly pronounced in the sub treatment where 7-9-9 animals out of 11 eviction groups also also heavier . In the queen treatment less so but still 9-9-7 out of 12 eviction groups.One will have to potentially pay attention to this in the models 


```{r Summary}

#All animals 
#Number of animals that are older and heavier/lighter
View(Older %>% 
  group_by(Treatment, DateType) %>% 
  summarize(Heavier = sum(WeightDiff_Cat == "Heavier"),
            Same = sum(WeightDiff_Cat == "Same"),
            Lighter = sum(WeightDiff_Cat == "Lighter")) %>% 
    ungroup())
#At eviction there are only 11 groups in the 


#Eviction group only
View(Older %>% 
       filter(EvictionStatus != "InGroup") %>% 
  group_by(Treatment, DateType) %>% 
  summarize(Heavier = sum(WeightDiff_Cat == "Heavier"),
            Same = sum(WeightDiff_Cat == "Same"),
            Lighter = sum(WeightDiff_Cat == "Lighter")) %>% 
    ungroup())
```


```{r Plot}

#Older as reference 
#Only we
ggplot(Older %>% 
         filter(EvictionStatus != "InGroup"), aes(x = AgeDiff, y = WeightDiff, color = Treatment)) +
  # Facet the plot by DateType, single column
  facet_wrap(~ DateType, ncol = 1) +
  # Add a horizontal line at y = 0
  geom_hline(yintercept = 0) +        
  #Add points, shaping by BS_Original
  geom_point(size = 2, aes(shape = EvictionStatus)) +
  geom_smooth(method = "lm", se=FALSE) +          
  theme_classic()                        


```


The reverse is also true and heavier animals tend to be Something to consider for model on p(win) is that block for heavier animals, will induce that are way way more negative than any other datapoints (because some helper are heavier at isolation)


```{r Plot}


#Heavier as reference   
ggplot(DeltaBMAge_Data  %>% filter(DateType == "Isolation"), aes(x = AgeDiff, y = WeightDiff, color = Treatment)) +
  
  #facet_grid(~DateType) +
  geom_hline(yintercept = 0) +
  
  geom_point(aes(shape = BS_Original)) + 
  
  geom_smooth(method = "lm") +
  
  theme_classic()

```


There is no correlation between age and bm differences whether the entire dataset is considered or models are applied on one treatment at a time, and whether isolation or pairing weight are considered

Perhaps I should rerun the code by excluding the two groups where we had no evictions as the existence of correlation is especially important for models on evictions

```{r Model Isolation}

#All data
LM_BMAgeDiff <- lm(WeightDiff ~ CentredAgeDiff * Treatment, 
                   data = BMDiff_LMdata  %>% 
                     filter(DateType == "Isolation"))
summary(LM_BMAgeDiff)
#Nothing significant


#Sub treatment
LM_BMAgeDiff_ST <- lm(WeightDiff ~ CentredAgeDiff, 
                   data = BMDiff_LMdata %>% 
                     filter(DateType == "Isolation",
                            Treatment == "Sub"))
summary(LM_BMAgeDiff_ST)
#No correlation 


#Queen treatment 
LM_BMAgeDiff_QT <- lm(WeightDiff ~ CentredAgeDiff, 
                   data = BMDiff_LMdata %>% 
                     filter(DateType == "Isolation",
                            Treatment == "Queen"))
summary(LM_BMAgeDiff_QT)
#No correlation 

```

```{r Model Pairing}

#All data
LM_BMAgeDiff_P <- lm(WeightDiff ~ CentredAgeDiff * Treatment, 
                   data = BMDiff_LMdata  %>% 
                     filter(DateType == "Pairing"))
summary(LM_BMAgeDiff_P)
#Nothing


#Sub treatment
LM_BMAgeDiff_ST_P <- lm(WeightDiff ~ CentredAgeDiff, 
                   data = BMDiff_LMdata %>% 
                     filter(DateType == "Pairing",
                            Treatment == "Sub"))
summary(LM_BMAgeDiff_ST_P)
#No correlation 


#Queen treatment 
LM_BMAgeDiff_QT_P <- lm(WeightDiff ~ CentredAgeDiff, 
                   data = BMDiff_LMdata %>% 
                     filter(DateType == "Pairing",
                            Treatment == "Queen"))
summary(LM_BMAgeDiff_QT_P)
#No correlation



```


#Eviction

Eviction occurred in all but two group, both from the sub treatment
(DevilsPeak, DOS = 18/07/2022, Lion = 02/03/2023).

and in all but one
group from the queen treatment (Tusker, DOS = 18/01/2022).

Co-breeding only occur in Tusker from the queen treatment. Check that it
is the case

It is worth noticing (see later plots) that groups where there is no
eviction are characterized by relatively larger BM and Age difference


## Occurence

The introduction of a male immigrant increased the occurrence of conflict from 0 to 92% of the groups (23/25)

There is no significant differences in the occurrence of eviction 

```{r No eviction}

#Groups without eviction
View(DC_Info_F %>% 
       filter(EvictionStatus == "InGroup"))
#3 groups without eviction 2 in sub treatment
#Group from queen treatment is co-breeding


View(DC_Info_F %>% 
       filter(EvictionStatus == "Evictor"))

```


```{r Data}

#Occurrences of eviction 
EvictionOcc <- DC_Info_F %>% 
  distinct(ExperimentalGroup, .keep_all = TRUE) %>% 
  mutate(Eviction = case_when(!is.na(EvictionDate) ~ "Yes",
                              TRUE ~ "No")) %>% 
  mutate(Period = "Post") %>% 
  select(ExperimentalGroup,
         Treatment,
         Period,
         Eviction) %>% 
  bind_rows(., 
            DC_Info_F %>% 
  distinct(ExperimentalGroup,Treatment) %>% 
  mutate(Period = "Pre",
         Eviction = "No")) %>% 
  #RELEVEL
  mutate(Period = fct_relevel(Period,"Pre","Post"),
         Treatment = fct_relevel(Treatment, "Sub", "Queen"))
View(EvictionOcc)

```


```{r glmmTMB}

str(EvictionOcc)
library(lme4)

#binomial model 
EvictionOcc_M1 <- glmmTMB(as.factor(Eviction) ~ Period,
                          family = "binomial",
                          data = EvictionOcc)
summary(EvictionOcc_M1)
#There is complete separation of data that creates an issue in the model estimation
```

Complete separation of data can be dealt with firth model, exact logistic regression or bayesian approach

Firth Logistic Regression: A penalized likelihood approach that can handle complete separation 


```{r Firth}

# Firth Logistic Regression
#use a logit link
firth_model <- logistf(Eviction ~ Period * Treatment, data = EvictionOcc)
summary(firth_model)


```


##Exact logistic 

Exact logistic regression does not seem to work 

```{r Exact logistic}

EvictionOcc_elrm_data <- EvictionOcc  %>% 
  group_by(Treatment, Period) %>% 
  summarize(Success = sum(Eviction == "Yes"),
            Total = n(),
            Fail = Total - Success) %>% 
  ungroup()
str(EvictionOcc_elrm_data)
View(EvictionOcc_elrm_data)

#Models
exact_model <- elrm(formula = Success/Total ~ Period * Treatment, 
                    interest =  ~ Period*Treatment,
                    data = EvictionOcc_elrm_data, iter = 50000)
summary(exact_model)

```


##Brms

I would be tempted to follow this approach but would eed to learn a bit more about brms and ask Jack about it 

How to plot? 
How to plot results?
Plot posterior?
How to plot interactions? 
How to conduct model validations?

Perhaps I could just ask Jack a little tutorial?


```{r}

# Fit the Bayesian logistic regression model
brms_model <- brm(
  formula = Eviction ~ Treatment * Period,
  family = bernoulli(),
  data = EvictionOcc,
  prior = set_prior("normal(0, 10)", class = "b"),  # Set a weakly informative prior
  chains = 4,  # Number of Markov Chains
  iter = 2000,  # Number of iterations per chain
  warmup = 1000,  # Number of warmup iterations per chain
  seed = 123  # Seed for reproducibility
)


# Print the model summary
summary(brms_model)

# Plot posterior distributions
plot(brms_model)

# Check diagnostics
#What does this mean? I do not really undesrtand what it shows
pp_check(brms_model)

```


## Eviction delay

```{r Summary}


#Eviction delay by sampling category
EvictionDelay_Summary <- DC_Info %>% 
  left_join(., SamplingCat) %>% 
  group_by(Sampling_Cat) %>% 
  summarize(Min = min(EvictionPairingDayDiff, na.rm = T),
         Max = max(EvictionPairingDayDiff, na.rm = T),
         Median = median(EvictionPairingDayDiff, na.rm = T),
         Avg = mean(EvictionPairingDayDiff, na.rm = T),
         FirstQuartile = quantile(EvictionPairingDayDiff, probs = 0.25, na.rm = T),
         ThirdQuartile = quantile(EvictionPairingDayDiff, probs = 0.75, na.rm = T),
         SD = sd(EvictionPairingDayDiff, na.rm = T))
View(EvictionDelay_Summary)


#Eviction delay by sampling category and treatment
EvictionDelay_Summary <- DC_Info %>% 
  left_join(., SamplingCat) %>% 
  group_by(Treatment, EvictionCategory, Sampling_Cat) %>% 
  summarize(Min = min(EvictionPairingDayDiff, na.rm = T),
         Max = max(EvictionPairingDayDiff, na.rm = T),
         Median = median(EvictionPairingDayDiff, na.rm = T),
         Avg = mean(EvictionPairingDayDiff, na.rm = T),
         FirstQuartile = quantile(EvictionPairingDayDiff, probs = 0.25, na.rm = T),
         ThirdQuartile = quantile(EvictionPairingDayDiff, probs = 0.75, na.rm = T),
         SD = sd(EvictionPairingDayDiff, na.rm = T))
View(EvictionDelay_Summary)



#Isolation delay
#Must be added in DC_Info
# IsolationDelay_Summary <- DC_Info_F %>% 
#   group_by(Treatment) %>% 
#   summarize(Min = min(IsolationPeriod),
#          Max = max(IsolationPeriod),
#          Median = median(IsolationPeriod),
#          Avg = mean(IsolationPeriod),
#          FirstQuartile = quantile(IsolationPeriod, probs = 0.25),
#          ThirdQuartile = quantile(IsolationPeriod, probs = 0.75),
#          SD = sd(IsolationPeriod))
# View(IsolationDelay_Summary)

#Conception delay
# View(DC_Info_Group %>% 
#        select(ExperimentalGroup,
#               Treatment,
#               PairingDate,
#               ConceptionDelay) %>% 
#        arrange(Treatment,
#                ConceptionDelay))

```

16 evictions occured within 21 days (11S, 5 Q) 2 evictions occurred
between 51 and 100 days 1 eviction between 101 and 150 3 eviction after
151

All eviction after 21 days are in the queen treatment

```{r Category Count}

#Count of eviction based on delay between pairing and eviction
Eviction_DelayCat_Count <- DC_Info_F %>% 
  group_by(ExperimentalGroup) %>% 
  slice_head() %>% 
  ungroup() %>% 
  group_by(Treatment) %>% 
  summarize("21" = sum(EvictionPairingDayDiff <= 21, na.rm = TRUE),
            "22_50" = sum(EvictionPairingDayDiff > 21 & EvictionPairingDayDiff <= 50 , na.rm = TRUE),
            "51_100" = sum(EvictionPairingDayDiff > 50 & EvictionPairingDayDiff <= 100 , na.rm = TRUE),
            "101_150" = sum(EvictionPairingDayDiff > 100 & EvictionPairingDayDiff <= 150 , na.rm = TRUE), 
            "151_" = sum(EvictionPairingDayDiff > 150, na.rm = TRUE),
            No_Eviction = sum(is.na(EvictionPairingDayDiff))) %>% 
  ungroup()
View(Eviction_DelayCat_Count)
#All evictions occured within 21 days in the sub treatment 

#All groups where evictions occurred after 21 days are from the queen treatment (n=6).
#In these 6 groups, the queen was always evicted and the sub gave birth on average 104 days after eviction

#It makes sense to create two categories of eviction, Rapid (<= 21 days) and slow (+21 days, in reality always more than 50 days)
#I have implemented this in DC_Info_F at the beginning of the current code

```

##Detailed Category

The sampling 

```{r Data}

names(DC_Info_F)

#Add sampling cat to DC_Info
DC_Info_F <- DC_Info_F %>% 
  left_join(., SamplingCat)

#Keep relevant data 
SamplingCat_Info <- DC_Info_F %>% 
  select(ExperimentalGroup, 
         AnimalID, 
         BS_Original,
         EvictionStatus,
         Treatment,
         Sampling_Cat, 
         EvictionPairingDayDiff,
         FirstConceptionPairingDayDiff,
         FirstConceptionEvictionDayDiff,
         FirstParturitionPairingDayDiff,
         FirstParturitionEvictionDayDiff,
         Eviction_GS) %>% 
  
  #ARRANGE
  arrange(Treatment, EvictionPairingDayDiff)
View(SamplingCat_Info)

```


```{r Sample size}

#separating by treatment 
SamplingCat_Count_ByTreat <- SamplingCat_Info %>% 
  group_by(ExperimentalGroup) %>% 
  filter(EvictionStatus == "Evictor" | is.na(EvictionStatus)) %>%
  slice_head() %>% 
  ungroup() %>% 
  group_by(Treatment, Sampling_Cat) %>% 
  summarize(Count = n(), 
            Max = max(FirstParturitionEvictionDayDiff, na.rm = TRUE),
            Min = min(FirstParturitionEvictionDayDiff, na.rm = TRUE),
            Median = median(FirstParturitionEvictionDayDiff, na.rm = TRUE),
            Avg = mean(FirstParturitionEvictionDayDiff, na.rm = TRUE),
            FirstQuartile = quantile(FirstParturitionEvictionDayDiff, probs = 0.25, na.rm = TRUE),
            ThirdQuartile = quantile(FirstParturitionEvictionDayDiff, probs = 0.75, na.rm = TRUE),
            SD = sd(FirstParturitionEvictionDayDiff, na.rm = TRUE)
            ) %>% 
  ungroup()
View(SamplingCat_Count_ByTreat)


#Not separatd by treatment
SamplingCat_Count <- SamplingCat_Info %>% 
  group_by(ExperimentalGroup) %>% 
  filter(EvictionStatus == "Evictor" | is.na(EvictionStatus)) %>%
  slice_head() %>% 
  ungroup() %>% 
  group_by(Sampling_Cat) %>% 
  summarize(Count = n(), 
            Max = max(FirstParturitionEvictionDayDiff, na.rm = TRUE),
            Min = min(FirstParturitionEvictionDayDiff, na.rm = TRUE),
            Median = median(FirstParturitionEvictionDayDiff, na.rm = TRUE),
            Avg = mean(FirstParturitionEvictionDayDiff, na.rm = TRUE),
            FirstQuartile = quantile(FirstParturitionEvictionDayDiff, probs = 0.25, na.rm = TRUE),
            ThirdQuartile = quantile(FirstParturitionEvictionDayDiff, probs = 0.75, na.rm = TRUE),
            SD = sd(FirstParturitionEvictionDayDiff, na.rm = TRUE)
            ) %>% 
  ungroup()
View(SamplingCat_Count)

```


#Category 1: Rapid - Conception 

There are 12 groups where the evictor evicted within 8 days of pairing
and around the time it conceived.

- 9x in Sub treatment 
- 3x in Queen treatment (evictor: 2x queen, 1x sub).


QUESTION: 

i) The reproductive state of the evictee is unknown and will be determined through hormone analysis. None of the evictee gave birth after eviction

```{r Rapid Conception}

#Group
RapidConc <- SamplingCat_Info %>% 
  filter(Sampling_Cat == "Rapid_Conc")
View(RapidConc)

```


#Category 2: Rapid - PreFirst

There are 4 groups where the evictor evicted within 21 days of pairing and
before their first successful gestation

Sub treatment: n = 2

- Darling Brew: RRF006 evicted RRF010 21 days post-pairing, 116 days pre-first 

- Firestone: SOF006 evicted SOF002 2 days post-pairing, approximately 114 days pre-first (since we do not know exact day of parturition). Following her death the male DRM006 was reused to form Kasteel  

Queen treatment: n = 2

- Chouffe: Helper PPF008 evicted Queen WEF005 on day 1 post-pairing, 140 days pre-first

- BitBurger: Helper MBF004 evicted Queen DRF004 on day 2 post-pairing, 132 days pre-first. DRF004 gave birth after eviction but conception occurred 98 days after eviction suggesting it was caused by an unplanned immigration


QUESTION: 

i) The reproductive state of evictor at eviction is unknown. Like for Cat 1, they could have evicted around RA or alternatively started ovulating much later. 

ii) The reproductive state of evictee at eviction is unknown, but there is no need to sample past eviction as males were absent. 

```{r Rapid Pre-first}

RapidPre <- SamplingCat_Info %>% 
  filter(Sampling_Cat == "Rapid_PreFirst" | ExperimentalGroup == "Firestone")
View(RapidPre)

View(DC_Info_F)


```


Firestone is a special case and a DOB has been manually assigned in DC_DataPrep (though not in Litter_Info, so does not cascade everywhere)

```{r Firestone}

Firestone <- RapidPre <- DC_Info_F %>% 
  filter(ExperimentalGroup == "Firestone")

View(Firestone)

```


#Category 3: Slow - Conc

3 groups, all from queen treatments (all slow eviction are from Q treatment)

- Leffe: ERF002 (H) evicted KGF002 (Q) on day 94 post-pairing, 87 days before first parturition. KGF002 activated on day 6 post-pairing and gave birth 91 days post pairing. She was lactating 3 days old pups when evicted (check if pups were alive)

- Licher: RRF004 (H) evicted VGF001 (Q) on day 72 post-pairing, 94 days before first parturition. VGF001 activated latest 27 days post-pairing and gave birth 115 days post pairing, 43 days after eviction. She was in the second trimester of gestation when when evicted.

- BlackLabel: TMF002 (H) evicted Z3F043 (Q) on day 152 post pairing, 90 days before first parturition. Z3F043 activated latest 87 days post pairing and gave birth 175 days post-pairing, 22 days after eviction. She was in the last trimester of gestation when she was evicted.


QUESTION: 

i) The reproductive state of evictor at eviction is unknown. RA or later ovulation


```{r Slow conception}

SlowConc <- SamplingCat_Info %>% 
  filter(Sampling_Cat == "Slow_Conc")
View(SlowConc)

```



#Category 4: Slow - PreFirst

2 groups, all from the queen treatment

- Guinness: RSF008 (H) evicted DRF015 (Q) 133 days post-pairing, 207 days before first parturition. DRF006 activated latest 36 days post pairing and gave birth 121 days post pairing. She was lactating her first litter when evicted (Check if pups alive at eviction)

- Corbeau: SOF001 (H) evicted ARF028 (Q) 227 days post-pairing, 129 days before first parturition. ARF028 activated 10 days post pairing and gave birth 121 days post pairing. She was evicted on the day she gave birth do her second litter

QUESTION

i) The reproductive state of evictor at eviction is unknown. RA or later ovulation


```{r Slow pre-first}

SlowPre <- SamplingCat_Info %>% 
  filter(Sampling_Cat == "Slow_PreFirst")
View(SlowPre)

View(Litter_Info)

```


#Category 5: Slow - PreFirst - No birth

1 group from the queen treatment

Wicklowolf:  ORF017 (H) evicted VGF002 (Q) 210 days after pairing on the 28/09/2023. VGF002 conceived latest 9 days post pairing, and gave birth 94 days post-pairing. She produced a second litter 204 days post pairing and was evicted when she was lactating 6 days old pups (Check if pups alive). 

I expect ORF017 to eventually get pregnant and for this group to fall into Cat 5. She would then be very similar to Corbeau


QUESTION

i) The reproductive state of evictor at eviction is unknown. Anovulatory, RA or later eviction


```{r Slow no eviction}

SlowNone <- SamplingCat_Info %>% 
  filter(Sampling_Cat == "Slow_None")
View(SlowNone)

View(DC_Info_F %>% 
       filter(ExperimentalGroup == "WicklowWolf"))

View(Litter_Info)

```



Category 6: No eviction 

There are 3 groups where there was no eviction


-  Devils Peak: Sub treatment, no co-breeding. DVF048 activated latest 30 days post pairing and produced a litter 118 post-pairing. She died 229 days after pairing 1 month before she was expected for her second litter. The remaining subordinate DVF061 activated latest 353 days post-pairing when she conceived her first litter to which she gave birth 441 days post pairing. 


QUESTION 

i) The reproductive state of DVF061 before her first conception is unknown
ii) We don't know whether eviction would have eventually occur


Lion: This could be a real co-breeding as in Tusker but may be too early to tell. BEF006 (H) has produced two litters, the last one on the 27/11/2023. BEF036 (H) produced one litter in the middle of it. BEF006 activated latest 6 days post pairing and BEF036 96 days post-pairing.   


Tusker: There is real Co-breeding here as COF014 (Q) and KBF006 (H) are breeding alongside each other with overlap in gestation. COF014 has produced 5 litters whereas KBF006 has produced 4. COF014 activated latest 3 days post-pairing and KBF006 activated latest 12 days post-pairing.

Tusker must now be moved as there has been an aviction


```{r None}

None <- SamplingCat_Info %>% 
  filter(Sampling_Cat == "NoEviction")
View(None)

```

```{r DevilsPeak}

DP <- DC_Info_F %>% 
  filter(ExperimentalGroup == "DevilsPeak")
View(DP)

```

```{r Tusker}

Tusker <- DC_Info_F %>% 
  filter(ExperimentalGroup == "Tusker")
View(Tusker)


View(Litter_Info %>% 
       filter(AnimalID %in% c("COF014", "KBF006")) %>% 
       arrange(LitterRef))

```

```{r Lion}

Lion <- DC_Info_F %>% 
  filter(ExperimentalGroup == "Lion")
View(Lion)

View(Litter_Info %>% 
       filter(AnimalID %in% c("BEF006", "BEF036")) %>% 
       arrange(LitterRef))

```

In cases where queens were evicted after a long time, how quickly did
they activate their reproductive axis

3 queens got pregnant immediately after pairing

3 queens got pregnant longer after pairing

```{r}


Queens_PartNoEvict <- SamplingCat_Info %>% 
  filter(Sampling_Cat %in% c("Slow_Conc", 
                             "Slow_PreFirst", 
                             "Slow_None"),
         BS_Original == "Breeder") %>% 
  
  #ADD PARTURITION DATE
  left_join(., DC_Info_F %>% 
              select(AnimalID, 
                     ConceptionPairingDayDiff))
View(Queens_PartNoEvict)

View(DC_Info_F)

View(Litter_Info)


```

What are the females that activated based their reproductive axis based
on LH but did not evict?

The list may grow once we have the results of hormone analyses

This can be used to ask whether eviction is associated with activation
more than expected by chance.

```{r Activation no eviction}

Activ_NoEviction <- DC_Info_F %>% 
  filter(ExperimentalGroup %in% c("Tusker", "Lion") | #COBREEDING LION GAVE BIRTH 7TH NOV
           AnimalID %in% c("DVF048") | #DEVILS SINGLE BREED (second female conceived after death of DVF048)
           Sampling_Cat %in% c("Slow_Conc","Slow_Pre") & BS_Original == "Breeder") | #BREEDER EVICTED AFTER CONCEIVED 
           ExperimentalGroup == "WickloWolf" & BS_Original == "Breeder")

```

##Model differences in eviction delay

```{r Model function}


#Lm 
evictiondelay_lm <- function(df) {
  glmmTMB( EvictionPairingDayDiff ~ Treatment, data = df)
}


#Poisson
evictiondelay_poiss <- function(df) {
  glmmTMB(EvictionPairingDayDiff ~ Treatment, family = poisson, data = df)
}

#Generalized poisson
evictiondelay_genpoiss <- function(df) {
  glmmTMB(EvictionPairingDayDiff ~ Treatment, family = genpois, data = df)
}
#Not tried yet

#Gamma models
evictiondelay_gamma <- function(df) {
  glmmTMB(EvictionPairingDayDiff ~ Treatment, family = "Gamma", data = df)
}

#Gamma models
evictiondelay_gammalog <- function(df) {
  glmmTMB(EvictionPairingDayDiff ~ Treatment, family = Gamma(link="log"), data = df)
}

#Not tried yet
#Negative binomial 1
evictiondelay_nb1 <- function(df) {
  glmmTMB(EvictionPairingDayDiff ~ Treatment, family = nbinom1, data = df)
}

#Negative binomial 2
evictiondelay_nb2 <- function(df) {
  glmmTMB(EvictionPairingDayDiff ~ Treatment, family = nbinom2, data = df)
}

evictiondelay_tweedie <- function(df) {
  glmmTMB(EvictionPairingDayDiff ~ Treatment, data = df, family = "tweedie")
}

#Does not work, I ma not sure why. Perhaps because there is no random effect? 
evictiondelay_tweedieD <- function(df) {
  glmmTMB(EvictionPairingDayDiff ~ Treatment, data = df, dispformula = ~Treatment, family = tweedie)
}



```

```{r Model dataset}

#Nested dataset
EvictionDelay_Nested <- DC_Info_Group %>% 
  select(ExperimentalGroup,
         Treatment,
         EvictionPairingDayDiff) %>% 
  mutate(EvictionPairingDayDiff = as.integer(EvictionPairingDayDiff)) %>% 
  nest()
View(EvictionDelay)

```

```{r Run Model}

EvictionDelay_Models_Wide <- EvictionDelay_Nested %>%
  
  #RUN MODEL OVER EACH ROWS
  #How could I automate this in one line of code 
  #To learn
  mutate(LM = map(data, evictiondelay_lm),
         P = map(data, evictiondelay_poiss),
         GP = map(data, evictiondelay_genpoiss),
         G = map(data, evictiondelay_gamma),
         GLog = map(data,evictiondelay_gammalog),
         NB1 = map(data, evictiondelay_nb1),
         NB2 = map(data, evictiondelay_nb2),
         Tw = map(data, evictiondelay_tweedie),
         TwD = map(data, evictiondelay_tweedieD))


#Long format
EvictionDelay_Models <- EvictionDelay_Models_Wide %>% 
  
  pivot_longer(cols = LM:TwD, names_to = "ModelType", values_to = "Model")

View(EvictionDelay_Models)

```

```{r MOdel info}


#Model info 
#Treatment to be used in predict function
pdata <- data.frame(Treatment = c("Sub", "Queen"))


#Put all model info together
EvictionDelay_Models_Info <- EvictionDelay_Models %>%
  
  #MODEL INFO 
  #Returned as list 
  mutate(Info = purrr::map(Model, ~family(.x))) %>% 
  
  #ADD FAMILY
  mutate(Family = purrr::map(Info, ~ pluck(.x$family))) %>% 
  
  #ADD LINK 
  mutate(Link = purrr::map(Info, ~ pluck(.x$link))) %>% 
  
  #ADD LINK INVERSE 
  mutate(LinkInv = purrr::map(Info, ~ pluck(.x$linkinv))) %>% 
  
  #ADD AIC 
  mutate(AIC = purrr::map_dbl(Model,~AIC(.x))) %>% 
  
  #ADD SIMULATED RESIDUALS
  mutate(SimResid = map(Model, ~simulateResiduals(fittedModel = .x, plot = F))) %>% 
  
  # #GGPREDICT 
  # mutate(Effect = map(Model, ~ Effect(mod = .x, term = "Treatment"))) %>% 
  # 
    #ADD MODEL PREDICTION
  mutate(Predict = map(Model, ~ predict(.x, newdata = pdata, type = "link", se.fit = TRUE))) %>% 
  
  #ADD MODEL PREDICTION
  mutate(Predict_R = map(Model, ~ predict(.x, newdata = pdata, type = "response", se.fit = TRUE))) 
View(EvictionDelay_Models_Info)

```

```{r Model output}

#EffectSize
EvictionDelay_ModelOutput_Link <- EvictionDelay_Models_Info %>% 
  
  #ADD COEFF
  mutate(Coeff = map(Model, ~tidy(.x))) %>%
  
  #UNNEST MODEL COEFF 
  unnest(Coeff) %>% 

  #ADD CI
  #The std.error are the std.error of the contrast, not of the predicted values, except for the intercept (because the intercept is the predicted value in relation to which the contrasts are expressed)
  mutate(Lower = estimate - (1.96*std.error),
         Upper = estimate + (1.96*std.error)) %>% 
  
  mutate_if(is.numeric, round, 5) %>% 
  
  #SELECT 
  select(
         ModelType,
         term,
         estimate,
         std.error,
         statistic,
         p.value,
         Lower,
         Upper)
  
View(EvictionDelay_ModelOutput_Link)


```

```{r Best models}
#Based on AIC 
#All 3 give warning 
#would need to ask Jacky what they mena and what shoudl be chosen


#There are 3 models with AIC of 141
#Glog
#G
#Tweedie Dispersion


#GLog 
Model_ValidationPlot_GLog <-  EvictionDelay_Models_Info %>% 
  select(
         ModelType,
         SimResid) %>% 
  
  filter(ModelType == "GLog") %>% 
  
  #PLOT MODEL 
  mutate(ModelPlot = purrr::map(SimResid, ~plot(.x))) 


#Gamma
Model_ValidationPlot_G <-  EvictionDelay_Models_Info %>% 
  select(ModelType,
         SimResid) %>% 
  
  filter(ModelType == "G") %>% 
  
  #PLOT MODEL 
  mutate(ModelPlot = purrr::map(SimResid, ~plot(.x))) 

#Tweedie dispersion 
Model_ValidationPlot_G <-  EvictionDelay_Models_Info %>% 
  select(ModelType,
         SimResid) %>% 
  
  filter(ModelType == "TwD") %>% 
  
  #PLOT MODEL 
  mutate(ModelPlot = purrr::map(SimResid, ~plot(.x))) 


```

```{r Plot}

#Data
EvictionDelay <- DC_Info_Group %>% 
  left_join(.,DC_Info_F %>% 
              filter(EvictionStatus == "Evictor") %>% 
              select(ExperimentalGroup, 
                     BS_Original))

View(EvictionDelay)

#Plot
#Remove group without eviction
ggplot(EvictionDelay %>% 
         filter(!is.na(BS_Original)),
       aes(x=Treatment,y=as.integer(EvictionPairingDayDiff))) + 
  
  #ADD BOXPLOT
  geom_boxplot(outlier.shape = NA) +
  
  #ADD POINTS 
  geom_jitter(width = 0.3, height = 0, size = 2.5, aes(col = BS_Original)) +

  theme_classic()

```

###Eviction trigger

Is eviction triggered by activation, pregnancies or parturition of
Evictor? Evictee? Both?

Activation will be determined through hormone analyses and can for now
only be backtracked for animal that successfully gave birth.

Pregnancies can be determined through LH, but hormone analyses could
point detect undetected pregnancies .

4 females that were evicted produced a litter (Licher, Corbeau, Black
Label, Guiness).

Corbeau (129 days) and Guiness (12 days) gave birth before they were
evicted.

Licher (43 days) and Black label (23 days) gave birth after they were
evicted. Thus both were pregnant at the time of eviction

```{r}

names(DC_Info)

#Evicted females that gave birth 
Parturition_Evictee <- DC_Info %>% 
  filter(EvictionStatus == "Evictee" & !is.na(FirstParturitionDate))
View(Parturition_Evictee)

#Evicted female that gave birth before eviction 
Parturition_Evictee_Before <- Parturition_Evictee %>% 
  filter(EvictionDate > FirstParturitionDate)
View(Parturition_Evictee_Before)


#Evicted females that gave birth after eviction
Parturition_Evictee_After <- Parturition_Evictee %>% 
  filter(EvictionDate < FirstParturitionDate)
View(Parturition_Evictee_After)

```

#Relationship BM and Age

We had decided to constrain queen (which are also older) to be heavier.
Thus in the queen treatment, Age and BM will be confounded. Perhaps, it
would be good to add 4 queens that are lighter than sub?

Are age and BM confounded?

##Absolute

At the individual level, it does not seem. But what is most relevant is
to have a look at: i)queen treatment where queens are consistently older
but also heavier by design =\> we would need queen lighter than sub

ii) sub treatment: Are heavier animals consistently older

```{r Corvif}

```

```{r Plot}

#Correlation by breeding status 
#Points may be pulled by extreme points
ggplot(ClosestWeight_Milestone, aes(x = Age, y = Weight, color = BS_Original)) +
                           geom_point() + 
  geom_smooth(method = "lm")


#Correlation by breeding status and treatment 
#Points may be pulled by extreme points
ggplot(ClosestWeight_Milestone, aes(x = Age, y = Weight, color = PlotCategory)) +
                           geom_point() + 
  geom_smooth(method = "lm")


#Boxplot
ggplot(ClosestWeight_Milestone,
       aes(x=PlotCategory,y=Age/365)) + 
  
  #ADD BOXPLOT
  geom_boxplot(outlier.shape = NA) +
  
  #ADD POINTS 
  geom_jitter(width = 0.3, height = 0, size = 3, alpha = 0.8, aes(col = Weight)) +

  theme_classic()


```

#Relationship BM, Original BS and eviction

In the sub treatment, differences in body-mass are pretty consistent
throughout the experiment.

The heavier sub at isolation evicted the lighter sub in all but 2 groups
(8/10). i) Lighter animals (CUF031) evicted heavier (CUF012) in Trolls
ii) No eviction in Devils peak where DVF061 is \>35g heavier than DVF048

In the Queen treatment, differences in body-mass are pretty consistent
throughout the experiment, though variance seems to increase

In contrast to the sub treatment, heavier females are consistently
evicting lighter ones. In fact only 4/11 females that were heavier at
isolation evicted, including the two sub that were heavier than the
queen (Chouffe and BitBurger). 5/11 females, all queens, that were
heavier at isolation and pairing (3/5 at eviction) were evicted by the
lighter sub. 2/11 groups where the queen was heavier than then sub have
had no eviction.

Overall this highlight a different relationship between BM difference
and likelihood of eviction in the Sub and the queen treatment. This is
because despite being heavier, queen are more likely to be evicted than
sub. Out of the 9 cases where there was eviction, the queen evicted 2x
only and was evicted 7 times (2x it was lighter). 4 evicted queens were
lighter than the sub at eviction (2 at isolation) whereas 3 were heavier
(5 at isolation). That shows that among the 7 queens that were evicted,
two did not maintain their BM advantage.

Overall, it doesn't seem that the animals that evict have been gaining
more BM throughout the experiment, relative to the evictor (sometimes
the BM difference ecame more positive, sometimes more negative)

It is worth noticing that the three groups where there has been no
eviction (Sub: DevilsPeak, DOS = 18/07/2022; Queen: Tusker, DOS =
18/01/2022; WicklowWolf = 02/03/2023) are characterized by the largest
group difference (no competition?)

```{r Summary}

#SummaryTable Wide
SummaryTable_BMBS <- BM_EvictorFocal %>% 
   filter(EvictionStatus != "InGroup") %>% 
   group_by(DateType,
            Treatment,
            BS_Original) %>% 
   summarize(Heavier = sum(WeightDiff > 0),
          Lower = sum(WeightDiff <0)) %>% 
   ungroup()
View(SummaryTable_BMBS)
 

#Summary Long format
SummaryTable_BMBS_Long <- SummaryTable_BMBS %>% 
   pivot_longer(cols = Heavier:Lower,names_to = "BM",values_to = "Count")
View(SummaryTable_BMBS_Long)
 

#Plot 
ggplot(SummaryTable_BMBS_Long,
   aes(x = BS_Original, y = Count, fill = BM)) +
  facet_grid(DateType ~ Treatment) +
  geom_col(position = "stack")

```

```{r Details}

#No eviction 
View(EvictorFocal %>% 
       filter( EvictionStatus== "InGroup"))
#WicklowWolf in Q treatment
#Tusker in Q treatment 
#DevilsPeak in Sub treatment


#Lighter sub that evicted heavier sub
View(EvictorFocal %>% 
       filter(Treatment == "Sub",
              EvictionStatus != "Evictee",
              HeavierRef == 2))
View(EvictorFocal)
#1/10 CUF031 evicted CUF012 in Trolls


#Lighter sub at isolation that evicted heavier queen
View(EvictorFocal %>% 
       filter(Treatment == "Queen",
              BS_Original == "Helper",
              EvictionStatus == "Evictor",
              DateType == "Isolation",
              HeavierRef == 2))
#5 sub evicted queens that were lighter 


#Lighter sub at eviction that evicted heavier queen 
View(EvictorFocal %>% 
       filter(Treatment == "Queen",
              BS_Original == "Helper",
              EvictionStatus == "Evictor",
              DateType == "Eviction",
              WeightDiff <= 0))
#Licher
#Black Label 
#Corbeau 

```

##Focal heavier

In the queen treatment 3 evictee (4 until pairing) are heavier and all
of these individuals are queens

```{r Plot}

#Heavier as focal 
ggplot(HeavierIsol,
       aes(x=DateType,y=WeightDiff)) + 
  
  facet_wrap(~ Treatment) +
  
  #ADD BOXPLOT
  geom_boxplot(outlier.shape = NA) +
  
  #ADD POINTS 
  geom_jitter(width = 0.2, height = 0, size = 2.5, aes(col=EvictionStatus, shape = BS_Original)) +
  #geom_point(size = 2, alpha = 0.7, aes(col=EvictionStatus, shape = BS_Original)) +
  
  geom_line(aes(group = AnimalID), alpha = 0.5) +
  
  geom_hline(yintercept = 0) +

  theme_classic()


```

## Focal evictor

```{r Plot}

#Heavier as focal 
ggplot(EvictorFocal,
       aes(x=DateType,y=WeightDiff)) + 
  
  facet_wrap(~ Treatment) +
  
  #ADD BOXPLOT
  geom_boxplot(outlier.shape = NA) +
  
  #ADD POINTS 
  geom_jitter(width = 0.1, height = 0, size = 2.5, aes(col=BS_Original, shape = EvictionStatus)) +
  #geom_point(size = 2, alpha = 0.7, aes(col=EvictionStatus, shape = BS_Original)) +
  
  geom_line(aes(group = AnimalID), alpha = 0.5) +
  
  geom_hline(yintercept = 0) +

  theme_classic()


```

```{r Comparisons}

ggplot(ClosestWeight_Milestone,
       aes(x=EvictionStatus_Plot,y=Weight)) + 
  
  facet_grid(DateType ~ Treatment) +
  
  #ADD BOXPLOT
  geom_boxplot(outlier.shape = NA) +
  
  #ADD POINTS 
  geom_jitter(width = 0.1, height = 0, size = 2.5, aes(col=BS_Original, shape = EvictionStatus)) +
  #geom_point(size = 2, alpha = 0.7, aes(col=EvictionStatus, shape = BS_Original)) +
  
  geom_line(aes(group = ExperimentalGroup), alpha = 0.5) +
  
  geom_hline(yintercept = 0) +
  
  ylim(90,200)+

  theme_classic()


```

##For Loop I can try to replicate body mass of both females in the pair
throughout the experiment for each experimental unit. It will be useful
to see which of the body-mass are asscoiated with pregnancies (this
would affect the difference in body mass between the two individuals)

The figure should show:

Vertical lines: - Isolation - Pairing - Eviction - First parturition (of
both animals? only one)

LineType: - Original BS

Colour: - Final eviction status

This has been started but not finished. At this stage, I think it is
unecessary

```{r DataPrep}

#I will use isolation day as the reference 


#Join DC_Info with weight 
Plot_BM <- DC_Info %>%
  
  #RETAIN FEMALES
  filter(Sex == "F") %>% 
  
  #ADD WEIGHT
  left_join(.,DC_Weight) %>% 
  
  #ARRANGE
  arrange(ExperimentalGroup,
          AnimalID,
          WeightDate) %>%
  
  #ADD WEIGHT - ISOLATION DAY DIFF 
  mutate(Isolation_DayDiff = WeightDate - IsolationDate) %>% 

  #ADD WEIGHT - PAIRING DAY DIFF
  mutate(Pairing_DayDiff = WeightDate - PairingDate) %>% 
  
  #ADD PAIRING DAY DIFF TO PLOT
  mutate(Pairing_DayDiff_ToPlot = case_when(Pairing_DayDiff >= 0 ~ Pairing_DayDiff))

View(Plot_BM)

```

```{r One colony}
unique(Plot_BM$ExperimentalGroup)


#################################################Vertical lines

Pairing <- DC_Info_F %>% 
  filter(ExperimentalGroup == "Trolls") %>%
  mutate(PairingIsolation_DayDiff = PairingDate - IsolationDate) %>% #Could be added in DC_Info 
  pull(PairingIsolation_DayDiff) %>% 
  unique()
Pairing


Eviction <- DC_Info_F %>% 
  filter(ExperimentalGroup == "Trolls") %>%
  mutate(EvictionIsolation_DayDiff = EvictionDate - IsolationDate) %>% #Could be added in DC_Info 
  pull(EvictionIsolation_DayDiff) %>% 
  unique()
Eviction
  


#################################################Plot single group
  
  


ggplot(Plot_BM %>% 
         filter(ExperimentalGroup == "Trolls"), aes(x=Isolation_DayDiff, y=Weight, colour = EvictionStatus)) + 
  
  #ADD POINTS 
  geom_point(size = 1.5) +
  
  #ADD LINE
  geom_line(aes(group = AnimalID, linetype = BS_Original)) +
  
  #ADD VERTICAL LINES 
  geom_vline(xintercept = 0, colour = "black", linetype = "dashed") +
  geom_vline(xintercept = Pairing, colour = "blue", linetype = "dashed") +
  geom_vline(xintercept = Eviction, colour = "red", linetype = "dashed") +
  
  #POINT LABLELS
  geom_text(aes(label=Pairing_DayDiff_ToPlot, vjust= -0.5), size = 3) 
  #check_overlap = TRUE
      
 


```

```{r For loop}

```

#Relationship Age, Original BS and eviction

In the queen treatment, queens are obviously always older than the
subordinate they were paired with. Thus when queen evicts (n=2) they are
older and when sub evict (n=7) they are younger

In the sub treatment older evicted 7 times and younger evicted 2 times.
In

For future rounds we shall try to find younger sub that are heavier than
older sub (while maximizing BM difference? )

```{r Summary}

#This section is not really menaingful 

View(AgeDiff_EvictorFocal)

#SummaryTable Wide
SummaryTable_AgeBS <- AgeDiff_EvictorFocal  %>% 
   filter(EvictionStatus != "InGroup") %>% 
   group_by(Treatment,
            BS_Original) %>% 
   summarize(Older = sum(AgeDiff > 0),
          Younger = sum(AgeDiff <0), 
          Same = sum(AgeDiff == 0)) %>% 
   ungroup()
View(SummaryTable_AgeBS)
 

#Summary Long format
SummaryTable_AgeBS_Long <- SummaryTable_AgeBS %>% 
   pivot_longer(cols = Older:Same,names_to = "Age",values_to = "Count")
View(SummaryTable_AgeBS_Long)
 

#Plot 
ggplot(SummaryTable_AgeBS_Long,
   aes(x = BS_Original, y = Count, fill = Age)) +
  facet_grid(~ Treatment) +
  geom_col(position = "stack")


```

```{r Details}

#Younger sub that evicted older sub 
View(AgeDiff_EvictorFocal %>% 
       filter(Treatment == "Sub",
              AgeDiff <0) %>% 
       left_join(.,BM_EvictorFocal,by=c("AnimalID" = "AnimalID")))
#CUF031 (Trolls), lighter than evictee
#SOF006 (Firestone), heavier than evictee
#MIF016 (DjuDju), heavier than evictee


```

##Older focal

```{r Plot}


#Older as focal 
ggplot(OlderFocal,
       aes(x=Treatment,y=AgeDiff)) + 
  
  #ADD BOXPLOT
  geom_boxplot(outlier.shape = NA) +
  
  #ADD POINTS 
  geom_jitter(width = 0.1, height = 0, size = 2.5, aes(col=EvictionStatus)) +
  #geom_point(size = 2, alpha = 0.7, aes(col=EvictionStatus, shape = BS_Original)) +

  theme_classic()



```

##Evictor focal

```{r Plot}


#Heavier as focal 
#With InGroup
ggplot(AgeDiff_EvictorFocal,
       aes(x=Treatment,y=AgeDiff)) + 
  
  #ADD BOXPLOT
  geom_boxplot(outlier.shape = NA) +
  
  #ADD POINTS 
  geom_jitter(width = 0.1, height = 0, size = 2.5, aes(col=BS_Original, shape = EvictionStatus)) +
  
  geom_hline(yintercept = 0) +

  theme_classic()



#Heavier as focal 
#With InGroup
ggplot(AgeDiff_EvictorFocal %>% 
         filter(EvictionStatus != "InGroup"),
       aes(x=Treatment,y=AgeDiff)) + 
  
  #ADD BOXPLOT
  geom_boxplot(outlier.shape = NA) +
  
  #ADD POINTS 
  geom_jitter(width = 0.1, height = 0, size = 2.5, aes(col=BS_Original, shape = EvictionStatus)) +
  
  geom_hline(yintercept = 0) +

  theme_classic()


```

```{r Comparisons}

```

#Timing of eviction

Relative to pairing Relative to Conception Relative to Parturition When
the two females got pregant (Licher and Black Label)

#Taking into account the gestation status of both animals


#Difference between slow and fast eviction 

When eviction took longer to occur, it leaves much more scope for animals to gain or to lose BM. Did helpers that took longer to evict were younger, lighter, at more BM disadvantage than the one that evicted rapidly in the queen treatment

The other side could be that queen are not as much at a BM advantage in slow eviction and cannot evict immediately as opped to what helpers would do in the helper treatment. For a given dBM helpers are more likely to evict than queens

- Could plot dBM ~ EvictionTime. Are there larger differences in dBM in slow eviction. We are talking here changes between isol and eviction (slope) rather than absolute value. 

- Are there any correlation BM and dBM? 

- Use plot to have a look at what may happen
